<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adopte un surmulot</title>
  <meta name="description" content="Choisis un emplacement sur la carte, baptise ton surmulot et vois-le appara√Ætre parmi les adoptions.">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    :root { --bg:#0f1115; --fg:#f5f7fb; --muted:#a6adbb; --accent:#ff6fb5; --card:#171a21; --border:#232837; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,"Noto Sans";line-height:1.5}
    header{position:sticky;top:0;background:rgba(15,17,21,.8);backdrop-filter:saturate(140%) blur(8px);
      border-bottom:1px solid var(--border);padding:12px 20px}
    header .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    main{max-width:1100px;margin:32px auto;padding:0 20px}
    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:22px;align-items:start}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .hero h1{font-size:42px;margin:.2em 0}
    .hero p, label, .small{color:var(--muted)}
    #map{height:420px;border-radius:12px;border:1px solid var(--border);overflow:hidden}
    form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,textarea,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#10131a;color:var(--fg)}
    textarea{min-height:96px;resize:vertical}
    .full{grid-column:1/-1}
    .cta{background:var(--accent);color:#0b0f14;border:none;font-weight:700;cursor:pointer}
    .adoptions{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:18px}
    .adopt-card{border:1px dashed var(--border);border-radius:12px;padding:14px;background:#0f141b}
    footer{margin:40px 0;color:var(--muted);font-size:13px}
    @media (max-width:900px){.hero{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div style="font-size:20px">üêÄ</div>
      <div>Adopte un surmulot</div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="card">
        <h1>Adopte un surmulot</h1>
        <p>Choisis l‚Äôendroit sur la carte, baptise ton surmulot et il appara√Ætra dans la liste et sur la carte.</p>
        <ul class="small" style="margin-top:.6em">
          <li>üó∫Ô∏è Clique sur la carte pour placer ton surmulot (optionnel)</li>
          <li>üìù Remplis le formulaire</li>
          <li>‚ú® L‚Äôadoption reste visible pour tout le monde (stock√©e sur Supabase)</li>
        </ul>
      </div>
      <div class="card">
        <div id="map" role="img" aria-label="Carte centr√©e sur Paris 11e"></div>
      </div>
    </section>

    <section class="card" style="margin-top:22px">
      <h2 style="margin:0 0 10px 0">Formulaire d‚Äôadoption</h2>
      <form id="adopt-form">
        <div>
          <label for="name">Nom du surmulot</label>
          <input id="name" name="name" required placeholder="Ex. Frometon">
        </div>
        <div>
          <label for="guardian">Ton pr√©nom (affich√©)</label>
          <input id="guardian" name="guardian" required placeholder="Ex. Guillaume">
        </div>
        <div class="full">
          <label for="story">Petite histoire (facultatif)</label>
          <textarea id="story" name="story" placeholder="Ex. Rencontr√© pr√®s d‚Äôun square, adore les croissants secs."></textarea>
        </div>
        <div>
          <label for="date">Date d‚Äôadoption</label>
          <input id="date" name="date" type="date" required>
        </div>
        <input type="hidden" id="lat"><input type="hidden" id="lng">
        <button class="cta full" type="submit">Adopter ce surmulot</button>
      </form>
    </section>

    <section class="card" style="margin-top:22px">
      <h2 style="margin:0 0 10px 0">Adoptions r√©centes</h2>
      <div id="adoptions" class="adoptions" aria-live="polite"></div>
    </section>

    <footer>¬© 2025</footer>
  </main>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
  (function(){
    // ---------- CONFIG SUPABASE ----------
    const SUPABASE_URL = "https://YOUR-PROJECT-ref.supabase.co";      // <- remplace
    const SUPABASE_ANON_KEY = "YOUR-ANON-PUBLIC-KEY";                  // <- remplace
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- MAP ----------
    const DEFAULT_CENTER = [48.8619, 2.3790]; // Paris 11e
    const DEFAULT_ZOOM = 15;

    let map, lastMarker = null, markersLayer, markersById = new Map();

    // Ic√¥ne "surmulot rose"
    const RAT_ICON = L.icon({
      iconUrl:
        "data:image/svg+xml;utf8," +
        encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36">
            <circle cx="18" cy="18" r="16" fill="#ff6fb5"/>
            <circle cx="12" cy="16" r="3" fill="#fff"/>
            <circle cx="24" cy="16" r="3" fill="#fff"/>
            <circle cx="13" cy="16" r="1.3" fill="#000"/>
            <circle cx="23" cy="16" r="1.3" fill="#000"/>
            <path d="M12 23c2.5 1.5 9.5 1.5 12 0" stroke="#000" stroke-width="1.8" fill="none" stroke-linecap="round"/>
            <path d="M6 18c0-7 8-12 12-12s12 5 12 12" fill="none" stroke="#ff3fa1" stroke-width="2" opacity=".6"/>
            <path d="M27 24c4 0 5 3 3 5" stroke="#ff3fa1" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
        `),
      iconSize: [36, 36],
      iconAnchor: [18, 30],
      popupAnchor: [0, -28]
    });

    function initMap(){
      map = L.map('map', { scrollWheelZoom:true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);

      map.on('click', (e)=>{
        const {lat, lng} = e.latlng;
        if(lastMarker) map.removeLayer(lastMarker);
        lastMarker = L.marker([lat, lng], { icon: RAT_ICON }).addTo(map).bindPopup('Emplacement choisi');
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
        lastMarker.openPopup();
      });
    }

    // ---------- UI helpers ----------
    const $ = (id)=>document.getElementById(id);
    const escapeHtml = (s)=> (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    function popupHtml(item){
      const story = item.story ? `<p style="margin:.4em 0 0">${escapeHtml(item.story)}</p>` : '';
      return `<strong>${escapeHtml(item.name)}</strong><br/>par ${escapeHtml(item.guardian)} ‚Ä¢ ${new Date(item.date).toLocaleDateString('fr-FR')}${story}`;
    }

    function card(item){
      const story = item.story ? `<p>${escapeHtml(item.story)}</p>` : '';
      return `
        <article class="adopt-card">
          <h3 style="margin:.2em 0">${escapeHtml(item.name)}</h3>
          <p class="small">par ${escapeHtml(item.guardian)} ‚Ä¢ ${new Date(item.date).toLocaleDateString('fr-FR')}</p>
          ${story}
          <button data-jump="${item.id}" style="margin-top:8px">Voir sur la carte</button>
        </article>`;
    }

    function bindListClicks(){
      $('adoptions').onclick = (e)=>{
        const btn = e.target.closest('button[data-jump]');
        if(!btn) return;
        const m = markersById.get(btn.dataset.jump);
        if(m){ map.setView(m.getLatLng(), 16); m.openPopup(); }
      };
    }

    // ---------- SUPABASE: data ----------
    async function loadAll(){
      const { data, error } = await sb.from('adoptions').select('*').order('id', { ascending:false });
      if(error){ console.error(error); return []; }
      return data;
    }

    async function saveOne(item){
      const { error } = await sb.from('adoptions').insert(item);
      if(error){ console.error(error); alert("Erreur enregistrement"); }
    }

    function renderMarkers(items){
      markersLayer.clearLayers(); markersById.clear();
      items.forEach(item=>{
        if(item.lat==null || item.lng==null) return;
        const m = L.marker([item.lat, item.lng], { icon: RAT_ICON }).addTo(markersLayer).bindPopup(popupHtml(item));
        markersById.set(String(item.id), m);
      });
    }

    function renderList(items){
      $('adoptions').innerHTML = items.length ? items.map(card).join('') : '<p class="small">Aucune adoption pour le moment‚Ä¶</p>';
    }

    // ---------- SUBMIT ----------
    function initForm(){
      const $form = $('adopt-form');
      // Date du jour par d√©faut
      $('date').valueAsDate = new Date();

      $form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const fd = new FormData($form);

        // fallback : centre de la carte si pas de clic
        let plat = fd.get('lat'), plng = fd.get('lng');
        if(!plat || !plng){ const c = map.getCenter(); plat = c.lat; plng = c.lng; }

        const item = {
          id: Date.now(), // cl√© "client" simple
          name: fd.get('name').trim(),
          guardian: fd.get('guardian').trim(),
          story: (fd.get('story')||'').trim(),
          date: fd.get('date'),
          lat: parseFloat(plat),
          lng: parseFloat(plng)
        };

        await saveOne(item);
        const items = await loadAll();
        renderList(items); renderMarkers(items);

        // focus & popup si dispo
        const m = markersById.get(String(item.id));
        if(m){ map.setView(m.getLatLng(), 16); m.openPopup(); }

        // reset
        $form.reset(); $('date').valueAsDate = new Date(); $('lat').value=''; $('lng').value='';
        if(lastMarker){ map.removeLayer(lastMarker); lastMarker=null; }
      });
    }

    // ---------- Realtime (optionnel mais cool) ----------
    function initRealtime(){
      // √©coute les nouveaux enregistrements pour mettre √† jour instantan√©ment tous les clients
      sb.channel('adoptions-inserts')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'adoptions' }, async (payload)=>{
          const row = payload.new;
          // si d√©j√† pr√©sent (toi-m√™me), on ignore
          if(markersById.has(String(row.id))) return;
          const items = await loadAll();
          renderList(items); renderMarkers(items);
        })
        .subscribe();
    }

    // ---------- BOOT ----------
    window.addEventListener('load', async ()=>{
      initMap();
      initForm();
      bindListClicks();
      const items = await loadAll();
      renderList(items);
      renderMarkers(items);
      setTimeout(()=>{ map.invalidateSize(); }, 60);
      initRealtime();
    });
  })();
  </script>
</body>
</html>
