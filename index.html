<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adopte un surmulot</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    :root { --bg:#0f1115; --fg:#f5f7fb; --muted:#a6adbb; --accent:#ff6fb5; --card:#171a21; --border:#232837; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial;line-height:1.5}
    header{position:sticky;top:0;background:#0f1115;border-bottom:1px solid var(--border);padding:12px 20px}
    header .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    main{max-width:1200px;margin:32px auto;padding:0 20px}
    .hero{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px}
    #map{height:600px;border-radius:12px;border:1px solid var(--border);overflow:hidden}
    form{display:grid;grid-template-columns:1fr;gap:14px}
    input,textarea,button{width:100%;padding:14px;border-radius:10px;border:1px solid var(--border);background:#10131a;color:var(--fg);font-size:15px}
    textarea{min-height:120px;resize:vertical}
    .cta{background:var(--accent);color:#0b0f14;border:none;font-weight:700;cursor:pointer}
    .adoptions{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:18px}
    .adopt-card{border:1px dashed var(--border);border-radius:12px;padding:14px;background:#0f141b}
    footer{margin:40px 0;color:var(--muted);font-size:13px}
    @media(max-width:900px){.hero{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header><div class="brand"><div style="font-size:20px">üêÄ</div><div>Adopte un surmulot</div></div></header>

  <main>
    <section class="hero">
      <div class="card">
        <h1>Adopte un surmulot</h1>
        <p>Choisis un endroit sur la carte, baptise ton surmulot et partage le avec la commu.</p>
        <ul class="small" style="margin-top:.6em;color:#a6adbb">
          <li>üó∫Ô∏è Clique sur la carte pour placer ton surmulot</li>
          <li>üìù Remplis les informations de ton surmulot</li>
          <li>‚ú® Regarde la carte de tous les surmulots adopt√©s</li>
        </ul>
        <form id="adopt-form" style="margin-top:18px">
          <label>Nom du surmulot
            <input id="name" name="name" required placeholder="Ex. Frometon">
          </label>
          <label>Ton pr√©nom
            <input id="guardian" name="guardian" required placeholder="Ex. Guillaume">
          </label>
          <label>Petite histoire
            <textarea id="story" name="story" placeholder="Ex. Rencontr√© pr√®s d‚Äôun square, adore les croissants secs."></textarea>
          </label>
          <label>Date d‚Äôadoption
            <input id="date" name="adoption_date" type="date" required>
          </label>
          <input type="hidden" id="lat" name="lat">
          <input type="hidden" id="lng" name="lng">
          <button class="cta" type="submit">Adopter ce surmulot üêÄ</button>
        </form>
      </div>
      <div class="card"><div id="map"></div></div>
    </section>

    <section class="card" style="margin-top:24px">
      <h2>Adoptions r√©centes</h2>
      <div id="adoptions" class="adoptions"></div>
    </section>
  </main>
  <footer>¬© 2025</footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    // 1) SUPABASE CONFIG ‚Äî remplace par tes valeurs
    const SUPABASE_URL = "https://vfulbvhdbqmiehatvrfo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmdWxidmhkYnFtaWVoYXR2cmZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDYzNjksImV4cCI6MjA3MjIyMjM2OX0.5m_0uGSsz8XNFyviA9rqqPPe4ZlqXsSqVJ-1JoxZerU";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2) MAP
    const DEFAULT_CENTER = [48.8619, 2.3790], DEFAULT_ZOOM = 15;
    let map, lastMarker=null, markersLayer, markersById=new Map();

    // Ic√¥ne emoji üêÄ grande
    const EmojiIcon = L.divIcon({
      html: "<div style='font-size:48px'>üêÄ</div>",
      className: "",
      iconSize: [48,48],
      iconAnchor: [24,42],
      popupAnchor: [0,-36]
    });

    function initMap(){
      map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:"¬© OpenStreetMap" }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      map.on('click', e=>{
        const {lat,lng} = e.latlng;
        if(lastMarker) map.removeLayer(lastMarker);
        lastMarker = L.marker([lat,lng], {icon:EmojiIcon}).addTo(map).bindPopup("Emplacement choisi");
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
      });
    }

    // 3) UI helpers
    const $=id=>document.getElementById(id);
    const escapeHtml=s=>(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    const popupHtml = (it)=> {
      const story = it.story ? `<p>${escapeHtml(it.story)}</p>` : "";
      const d = new Date(it.adoption_date).toLocaleDateString('fr-FR');
      return `<b>${escapeHtml(it.name)}</b><br/>par ${escapeHtml(it.guardian)} ‚Ä¢ ${d}${story}`;
    };
    const card = (it)=> {
      const story = it.story ? `<p>${escapeHtml(it.story)}</p>` : "";
      const d = new Date(it.adoption_date).toLocaleDateString('fr-FR');
      return `<article class="adopt-card">
        <h3>${escapeHtml(it.name)}</h3>
        <p class="small">par ${escapeHtml(it.guardian)} ‚Ä¢ ${d}</p>
        ${story}
        <button data-jump="${it.id}">Voir sur la carte</button>
      </article>`;
    };

    // 4) DATA (CRUD minimal)
    async function loadAll(){
      const { data, error } = await sb.from("adoptions").select("*").order("id",{ascending:false});
      if(error){ console.error(error); return []; }
      return data;
    }
    async function saveOne(item){
      const { error } = await sb.from("adoptions").insert(item);
      if(error){ console.error(error); alert("Erreur enregistrement"); }
    }

    // 5) RENDER
    function render(items){
      $("adoptions").innerHTML = items.length ? items.map(card).join("") : "<p>Aucune adoption</p>";
      markersLayer.clearLayers(); markersById.clear();
      items.forEach(it=>{
        const m = L.marker([it.lat,it.lng], {icon:EmojiIcon}).addTo(markersLayer).bindPopup(popupHtml(it));
        markersById.set(String(it.id), m);
      });
    }

    // 6) FORM
    function initForm(){
      $("date").valueAsDate = new Date();
      $("adopt-form").addEventListener("submit", async ev=>{
        ev.preventDefault();
        const fd = new FormData(ev.target);
        let lat=fd.get("lat"), lng=fd.get("lng");
        if(!lat || !lng){ const c = map.getCenter(); lat=c.lat; lng=c.lng; }
        const item = {
          name: fd.get("name").trim(),
          guardian: fd.get("guardian").trim(),
          story: (fd.get("story")||"").trim(),
          adoption_date: fd.get("adoption_date"),   // ‚ö†Ô∏è correspond √† la colonne adoption_date
          lat: parseFloat(lat),
          lng: parseFloat(lng)
        };
        await saveOne(item);
        // Notre propre insert sera aussi capt√© par Realtime;
        // on ne force pas de reload ici pour √©viter deux re-renders rapproch√©s.
        ev.target.reset(); $("date").valueAsDate = new Date(); $("lat").value=""; $("lng").value="";
        if(lastMarker){ map.removeLayer(lastMarker); lastMarker=null; }
      });

      $("adoptions").addEventListener("click", e=>{
        const b = e.target.closest("button[data-jump]"); if(!b) return;
        const m = markersById.get(b.dataset.jump);
        if(m){ map.setView(m.getLatLng(), 16); m.openPopup(); }
      });
    }

    // 7) REALTIME
    function initRealtime(){
      // S'abonner aux INSERT sur public.adoptions
      sb.channel('adoptions-realtime')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'adoptions' }, async (_payload)=>{
          // √Ä chaque nouvel enregistrement ‚Üí on recharge proprement
          const items = await loadAll();
          render(items);
        })
        .subscribe((status)=>{ /* status: 'SUBSCRIBED' etc. */ });
    }

    // 8) BOOT
    window.addEventListener("load", async ()=>{
      initMap();
      initForm();
      const items = await loadAll(); render(items);
      initRealtime();
      setTimeout(()=>map.invalidateSize(),100);
    });
  })();
  </script>
</body>
</html>
