<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adopte un surmulot</title>

  <!-- Favicon RAT -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêÄ</text></svg>">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    :root{
      --bg:#0c0f14; --panel:#121722; --panel-2:#0f141e;
      --fg:#eaf0ff; --muted:#9aa5b2; --border:#1f2633;
      --accent:#ff6fb5; --accent-2:#ff92c7;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html,body{margin:0;background:#0c0f14;color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial}
    h1,h2{letter-spacing:.2px}
    h1{font-size:40px;margin:.1em 0 .2em}
    h2{font-size:22px;margin:0 0 .6em}
    header{position:sticky;top:0;z-index:10;background:rgba(12,15,20,.7);backdrop-filter:blur(10px) saturate(140%);border-bottom:1px solid var(--border)}
    .nav{display:flex;align-items:center;gap:12px;padding:14px 20px;font-weight:700;font-size:18px}
    .nav span.logo{font-size:22px;margin-right:6px}
    .container{max-width:1280px;margin:28px auto;padding:0 20px}
    .grid{display:grid;grid-template-columns: minmax(320px,7fr) minmax(320px,5fr);gap:24px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}h1{font-size:32px}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .inner{padding:18px}
    .subtle{color:var(--muted)}
    #map{height:64vh;min-height:480px;border-radius:calc(var(--radius) - 4px);border:1px solid var(--border);overflow:hidden}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0 16px}
    .btn, input, textarea{border:1px solid var(--border);border-radius:12px;background:var(--panel-2);color:var(--fg)}
    .btn{padding:10px 12px;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(180deg,var(--accent)0%,var(--accent-2)100%);color:#120a12;border:none}
    form{display:grid;grid-template-columns:1fr;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input,textarea{width:100%;padding:14px 12px;font-size:15px}
    textarea{min-height:120px;resize:vertical}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .adopt{background:var(--panel-2);border:1px dashed var(--border);border-radius:14px;padding:14px}
    .adopt h3{margin:.2em 0;font-size:18px}
    .meta{font-size:12px;color:var(--muted)}
    footer{margin:40px 0;color:#9aa5b2;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <span class="logo">üêÄ</span>
      <span>Adopte un surmulot</span>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Carte -->
      <section class="card"><div class="inner">
        <h1>Carte des surmulots</h1>
        <p class="subtle">Clique sur la carte pour placer ton surmulot (optionnel) ou utilise ta position.</p>
        <div class="row">
          <button id="geoloc" class="btn">üìç Me localiser</button>
          <small class="subtle">n√©cessite l‚Äôautorisation du navigateur</small>
        </div>
        <div id="map"></div>
      </div></section>

      <!-- Formulaire -->
      <section class="card"><div class="inner">
        <h2>Adopte un surmulot</h2>
        <form id="adopt-form">
          <label>Nom du surmulot
            <input id="name" name="name" required placeholder="Ex. Frometon">
          </label>
          <label>Ton pr√©nom
            <input id="guardian" name="guardian" required placeholder="Ex. Guillaume">
          </label>
          <label>Petite histoire
            <textarea id="story" name="story" placeholder="Ex. Rencontr√© pr√®s d‚Äôun square‚Ä¶"></textarea>
          </label>
          <label>Date d‚Äôadoption
            <input id="date" name="adoption_date" type="date" required>
          </label>
          <input type="hidden" id="lat" name="lat"><input type="hidden" id="lng" name="lng">
          <button class="btn btn-primary" type="submit">Adopter ce surmulot üêÄ</button>
        </form>
      </div></section>
    </div>

    <!-- Liste -->
    <section class="card" style="margin-top:24px"><div class="inner">
      <h2>Adoptions r√©centes</h2>
      <div id="adoptions" class="list"></div>
    </div></section>
  </div>

  <footer>Fait avec ‚ù§Ô∏è et üßÄ ‚Ä¢ ¬© 2025</footer>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    const SUPABASE_URL="https://vfulbvhdbqmiehatvrfo.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmdWxidmhkYnFtaWVoYXR2cmZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDYzNjksImV4cCI6MjA3MjIyMjM2OX0.5m_0uGSsz8XNFyviA9rqqPPe4ZlqXsSqVJ-1JoxZerU";
    const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

    const DEFAULT_CENTER=[48.8619,2.3790],DEFAULT_ZOOM=15;
    let map,lastMarker=null,markersLayer,markersById=new Map();

    const EmojiIcon=L.divIcon({
      html:"<div style='font-size:52px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.35))'>üêÄ</div>",
      className:"",iconSize:[52,52],iconAnchor:[26,46],popupAnchor:[0,-36]
    });

    function setHiddenLatLng(lat,lng){
      document.getElementById('lat').value=Number(lat).toFixed(6);
      document.getElementById('lng').value=Number(lng).toFixed(6);
    }

    function placeTempMarker(lat,lng){
      if(lastMarker) map.removeLayer(lastMarker);
      lastMarker=L.marker([lat,lng],{icon:EmojiIcon}).addTo(map).bindPopup("Emplacement choisi");
      lastMarker.openPopup();
      setHiddenLatLng(lat,lng);
    }

    function initMap(){
      map=L.map('map',{scrollWheelZoom:true}).setView(DEFAULT_CENTER,DEFAULT_ZOOM);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:"¬© OpenStreetMap"}).addTo(map);
      markersLayer=L.layerGroup().addTo(map);
      map.on('click',e=>{const {lat,lng}=e.latlng; placeTempMarker(lat,lng);});
    }

    // Bouton g√©oloc
    document.addEventListener('click', (e)=>{
      const btn=e.target.closest('#geoloc'); if(!btn) return;
      if(!navigator.geolocation){ alert("G√©olocalisation non support√©e."); return; }
      btn.disabled=true; btn.textContent="Recherche de la position‚Ä¶";
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude}=pos.coords;
        map.setView([latitude,longitude], 16);
        placeTempMarker(latitude,longitude);
        btn.disabled=false; btn.textContent="üìç Me localiser";
      }, err=>{
        alert("Impossible d‚Äôobtenir la position : " + err.message);
        btn.disabled=false; btn.textContent="üìç Me localiser";
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:30000});
    });

    const escapeHtml=s=>(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    const fmtDate=d=>new Date(d).toLocaleDateString('fr-FR');
    const popupHtml=it=>`<b>${escapeHtml(it.name)}</b><br/>par ${escapeHtml(it.guardian)} ‚Ä¢ ${fmtDate(it.adoption_date)}${it.story?`<p style="margin:.5em 0 0">${escapeHtml(it.story)}</p>`:""}`;
    const card=it=>`<article class="adopt"><h3>${escapeHtml(it.name)}</h3><div class="meta">par ${escapeHtml(it.guardian)} ‚Ä¢ ${fmtDate(it.adoption_date)}</div>${it.story?`<p>${escapeHtml(it.story)}</p>`:""}<button data-jump="${it.id}" class="btn btn-primary" style="margin-top:8px">Voir sur la carte</button></article>`;

    async function loadAll(){const {data,error}=await sb.from("adoptions").select("*").order("id",{ascending:false});if(error){console.error(error);return[]}return data}
    async function saveOne(item){const {error}=await sb.from("adoptions").insert(item);if(error){console.error(error);alert(error.message)}}

    function render(items){
      document.getElementById('adoptions').innerHTML=items.length?items.map(card).join(""):"<p class='subtle'>Aucune adoption</p>";
      markersLayer.clearLayers(); markersById.clear();
      items.forEach(it=>{const m=L.marker([it.lat,it.lng],{icon:EmojiIcon}).addTo(markersLayer).bindPopup(popupHtml(it));markersById.set(String(it.id),m)});
    }

    function initForm(){
      document.getElementById('date').valueAsDate=new Date();
      document.getElementById('adopt-form').addEventListener("submit",async ev=>{
        ev.preventDefault();
        const fd=new FormData(ev.target);
        let lat=fd.get("lat"),lng=fd.get("lng");
        if(!lat||!lng){const c=map.getCenter();lat=c.lat;lng=c.lng;}
        const item={name:fd.get("name").trim(),guardian:fd.get("guardian").trim(),story:(fd.get("story")||"").trim(),adoption_date:fd.get("adoption_date"),lat:parseFloat(lat),lng:parseFloat(lng)};
        await saveOne(item);
        ev.target.reset(); document.getElementById('date').valueAsDate=new Date(); setHiddenLatLng("",""); if(lastMarker){map.removeLayer(lastMarker); lastMarker=null;}
      });
      document.getElementById('adoptions').addEventListener("click",e=>{const b=e.target.closest("button[data-jump]");if(!b)return;const m=markersById.get(b.dataset.jump);if(m){map.setView(m.getLatLng(),16);m.openPopup();}});
    }

    function initRealtime(){
      sb.channel('adoptions-realtime').on('postgres_changes',{event:'INSERT',schema:'public',table:'adoptions'},async()=>{const items=await loadAll();render(items)}).subscribe();
    }

    window.addEventListener("load",async()=>{
      initMap(); initForm();
      const items=await loadAll(); render(items);
      initRealtime();
      setTimeout(()=>map.invalidateSize(),120);
    });
  })();
  </script>
</body>
</html>
